<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒŸ AI ç©ºä¸­å¯«å­—å°ç²¾éˆ ğŸŒŸ</title>
    <style>
        :root {
            --primary-bg: #e0f7fa;
            --teacher-color: #ff9800;
            --student-color: #4caf50;
            --accent-color: #00bcd4;
            --card-bg: rgba(255, 255, 255, 0.9);
        }

        body { 
            margin: 0; padding: 0; background: var(--primary-bg); 
            color: #333; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; 
            overflow: hidden; 
        }

        body::before {
            content: ""; position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.5) 0%, transparent 20%),
                        radial-gradient(circle at 90% 80%, rgba(255,255,255,0.5) 0%, transparent 20%);
            z-index: -1;
        }

        .page { display: none; width: 100vw; height: 100vh; position: absolute; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }

        .card { 
            background: var(--card-bg); padding: 35px; border-radius: 40px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 350px; text-align: center;
            border: 5px solid white;
        }

        h1 { color: #0288d1; font-size: 28px; text-shadow: 1px 1px 2px white; margin-bottom: 25px; }
        h2, h3, h4 { margin: 10px 0; color: #555; }

        input { 
            width: 100%; padding: 15px; margin: 10px 0; border-radius: 20px; 
            border: 2px solid #ddd; font-size: 18px; box-sizing: border-box; outline: none;
            transition: border-color 0.3s;
        }
        input:focus { border-color: var(--accent-color); }

        button { 
            width: 100%; padding: 15px; margin-top: 15px; border-radius: 50px; 
            border: none; background: #fff; color: #444; font-weight: bold; 
            cursor: pointer; font-size: 20px; transition: 0.3s;
            box-shadow: 0 6px 0 #ddd; position: relative; top: 0;
        }
        button:active { top: 4px; box-shadow: 0 2px 0 #ddd; }
        button:hover { background: #f0f0f0; }

        .btn-teacher { background: #ffb74d; color: white; box-shadow: 0 6px 0 #e65100; }
        .btn-student { background: #81c784; color: white; box-shadow: 0 6px 0 #2e7d32; }
        .btn-action { background: #4fc3f7; color: white; box-shadow: 0 6px 0 #0277bd; }
        .btn-delete { background: #ff8a65; color: white; box-shadow: 0 6px 0 #bf360c; font-size: 14px; padding: 8px; }

        #page_teacher_dash { overflow-y: auto; justify-content: flex-start; padding: 20px 0; background: #f1f8e9; }
        .dash-container { width: 95%; max-width: 1000px; display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .monitor-panel { background: white; padding: 20px; border-radius: 30px; flex: 1; min-width: 320px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        .room-manager { width: 95%; max-width: 1000px; background: white; padding: 15px; border-radius: 25px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .room-chip { background: #e1f5fe; padding: 8px 18px; border-radius: 30px; display: flex; align-items: center; gap: 8px; border: 2px solid #b3e5fc; cursor: pointer; color: #0277bd; font-weight: bold; }
        .room-chip.active { border-color: #4caf50; background: #e8f5e9; color: #2e7d32; }
        .room-chip .del-x { color: #ff5252; margin-left: 5px; }

        #page_writing { background: #000; }
        #overlay_canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .writing-ui { position: absolute; top: 25px; left: 25px; pointer-events: none; }
        .writing-info { 
            background: rgba(255,255,255,0.9); padding: 20px; border-radius: 30px; 
            border: 4px solid #81c784; color: #333; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-top: 10px; }
        th { padding: 12px; color: #0288d1; border-bottom: 2px solid #e1f5fe; }
        td { padding: 12px; background: #fafafa; border: none; }
        td:first-child { border-radius: 15px 0 0 15px; }
        td:last-child { border-radius: 0 15px 15px 0; }
        
        .work-thumb { width: 50px; height: 38px; border: 2px solid #81c784; cursor: pointer; object-fit: cover; background: #000; border-radius: 8px; transform: scaleX(-1); }

        #artwork_modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #big_art { max-width: 85%; max-height: 80%; border: 8px solid white; border-radius: 20px; transform: scaleX(-1); }
        
        /* ä¸€èˆ¬å–®å­—è©•åˆ†è¦–çª— */
        #result_modal { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 45px; border-radius: 50px; text-align: center; z-index: 2000; min-width: 320px; 
            border: 8px solid #ffeb3b; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        #res_score { font-size: 100px; font-weight: bold; color: #ff9800; margin: 10px 0; font-family: 'Comic Sans MS', sans-serif; }
        #res_stars { font-size: 45px; margin-bottom: 20px; }

        /* æœ€å¾Œçš„å¤§ç¸½çµè¦–çª— */
        #final_modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 50px; border-radius: 60px; text-align: center; z-index: 2500; min-width: 350px;
            border: 10px solid #4caf50; box-shadow: 0 25px 60px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body>

    <div id="artwork_modal" onclick="closeArt()"><span style="position:absolute; top:20px; right:30px; color:white; font-size:50px; cursor:pointer;">&times;</span><img id="big_art" src=""><div id="art_info" style="position: absolute; bottom: 40px; color: white; font-size: 24px; font-weight:bold;"></div></div>

    <div id="page_entry" class="page active">
        <div style="font-size: 80px; margin-bottom: 10px;">âœ¨</div>
        <h1>ç©ºä¸­å¯«å­—å°ç²¾éˆ</h1>
        <div class="card">
            <button class="btn-teacher" onclick="showPage('page_teacher_login')">è€å¸«ç®¡ç†ç«¯ ğŸ‘©â€ğŸ«</button>
            <button class="btn-student" onclick="showPage('page_student_info')">å­¸ç”Ÿç·´ç¿’ç«¯ ğŸ‘¦</button>
        </div>
    </div>

    <div id="page_teacher_login" class="page">
        <div class="card">
            <h2>ğŸ”‘ è€å¸«ç™»å…¥</h2>
            <input type="text" id="teacherAccount" placeholder="è¼¸å…¥å¸³è™Ÿ">
            <input type="password" id="teacherPassword" placeholder="è¼¸å…¥å¯†ç¢¼">
            <button class="btn-teacher" onclick="loginAsTeacher()">é–‹å§‹ä¸Šèª²</button>
            <button onclick="showPage('page_entry')" style="background:none; color:#999; font-size:14px; box-shadow:none;">è¿”å›é¦–é </button>
        </div>
    </div>

    <div id="page_teacher_dash" class="page">
        <div class="room-manager">
            <span style="font-weight:bold; color:#0288d1;">èª²å ‚æˆ¿è™Ÿï¼š</span>
            <div id="room_chips_container" style="display:flex; gap:8px;"></div>
            <div style="display:flex; gap:8px; margin-left:auto;">
                <input type="text" id="class_room_id" placeholder="æ–°æˆ¿è™Ÿ" style="margin:0; padding:8px; width:100px; border-radius:15px;">
                <button class="btn-action" onclick="saveRoomID()" style="margin:0; padding:8px 15px; width:auto; font-size:14px;">+ æ–°å¢</button>
            </div>
        </div>

        <div class="dash-container">
            <div class="monitor-panel">
                <h4>ğŸ“ å‡ºé¡Œæ¿</h4>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="new_word" placeholder="æ–°å–®å­—" style="margin:0;">
                    <button class="btn-student" onclick="addNewWord()" style="width:80px; margin:0; font-size:14px;">åŠ å…¥</button>
                </div>
                <div id="word_list" style="height:150px; overflow-y:auto; margin:15px 0; text-align:left; padding:10px; border:2px dashed #ddd; border-radius:15px;"></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-action" onclick="publishSelectedWords()">ğŸ“¢ ç™¼ä½ˆç·´ç¿’</button>
                    <button class="btn-delete" onclick="deleteSelectedWords()">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
                <div style="font-size:13px; color:#4caf50; margin-top:10px; font-weight:bold;">âœ¨ ç›®å‰ç™¼ä½ˆï¼š<span id="published_display" style="color:#666;">ç„¡</span></div>
            </div>

            <div class="monitor-panel" style="flex: 2;">
                <h4>ğŸ† é¾è™æ¦œ (æˆ¿è™Ÿ: <span id="room_display" style="color:#f57c00;">--</span>)</h4>
                <div style="max-height: 450px; overflow-y: auto;">
                    <table id="leaderboard">
                        <thead><tr><th>ä½œå“</th><th>å­¸ç”Ÿå§“å</th><th>å¹³å‡åˆ†</th><th>æ˜ç´°</th><th>é€²åº¦</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button onclick="clearScores()" style="background:#eee; font-size:12px; margin-top:15px; width:auto; padding:5px 15px; box-shadow:none; color:#999;">æ¸…ç©ºç´€éŒ„</button>
            </div>
        </div>
        <button onclick="showPage('page_entry')" style="background:none; color:#999; margin-top:20px; box-shadow:none; font-size:14px;">å®‰å…¨é€€å‡º ğŸšª</button>
    </div>

    <div id="page_student_info" class="page">
        <div class="card">
            <h2>ğŸ“ æº–å‚™å¥½å¯«å­—äº†å—ï¼Ÿ</h2>
            <input type="text" id="s_class" placeholder="ä½ çš„ç­ç´š (ä¾‹: 1A)">
            <input type="text" id="s_name" placeholder="ä½ çš„å§“å">
            <input type="text" id="s_room_input" placeholder="è«‹è¼¸å…¥è€å¸«çµ¦çš„æˆ¿è™Ÿ">
            <button class="btn-student" onclick="handleStudentEntry()">é€²å…¥æŒ‘æˆ° ğŸš€</button>
            <button onclick="showPage('page_entry')" style="background:none; color:#999; font-size:14px; box-shadow:none;">å›é¦–é </button>
        </div>
    </div>

    <div id="page_writing" class="page" style="padding:0;">
        <video id="input_video" style="visibility:hidden; position:absolute;"></video>
        <canvas id="overlay_canvas"></canvas>
        <div class="writing-ui">
            <div class="writing-info">
                <div style="font-size:42px; font-weight:bold; color:#2e7d32;" id="target_word">READY</div>
                <div id="progress_info" style="font-size:18px; color:#666; margin-top:5px; font-weight:bold;">ç¬¬ 0 / 0 å€‹</div>
            </div>
        </div>
        <div style="position:absolute; bottom:35px; left:50%; transform:translateX(-50%); display:flex; gap:25px;">
            <button onclick="clearCanvas()" style="width:110px; background:white; color:#333; box-shadow:0 6px 0 #ccc;">â™»ï¸ é‡å¯«</button>
            <button onclick="calculateFinalScore()" id="btn_submit_score" style="width:180px; background:#ff9800; color:white; box-shadow:0 6px 0 #e65100;">âœ… å®Œæˆæäº¤</button>
        </div>
    </div>

    <div id="result_modal">
        <div style="font-size: 28px; color: #0288d1; font-weight:bold;">å¤ªå²å®³äº†ï¼ğŸ‰</div>
        <div id="res_score">0</div>
        <div id="res_stars">â­â­â­</div>
        <button class="btn-action" onclick="toNextStep()">ç¹¼çºŒä¸‹ä¸€å€‹ â¡ï¸</button>
    </div>

    <div id="final_modal">
        <div style="font-size: 80px; margin-bottom: 10px;">ğŸ†</div>
        <div style="font-size: 32px; color: #2e7d32; font-weight:bold; margin-bottom: 10px;">æŒ‘æˆ°å¤§æˆåŠŸï¼</div>
        <div style="font-size: 18px; color: #666; margin-bottom: 30px;">ä½ å·²ç¶“å¯«å®Œæ‰€æœ‰çš„å–®å­—äº†ï¼Œ<br>è¦ä¸è¦å†ç·´ç¿’ä¸€æ¬¡å‘¢ï¼Ÿ</div>
        <button class="btn-student" onclick="restartChallenge()">å†ä¾†ä¸€æ¬¡ ğŸ”„</button>
        <button class="btn-action" style="background:#0288d1; box-shadow:0 6px 0 #01579b;" onclick="exitChallenge()">é€€å‡ºä¼‘æ¯ ğŸ </button>
    </div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, query, where, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDk5l70PQPSb0pIl6q-eyXU1IBF093F9FQ",
        authDomain: "writing-3646d.firebaseapp.com",
        databaseURL: "https://writing-3646d-default-rtdb.firebaseio.com",
        projectId: "writing-3646d",
        storageBucket: "writing-3646d.firebasestorage.app",
        messagingSenderId: "268020200454",
        appId: "1:268020200454:web:d0b12c77a91efeecf33f87",
        measurementId: "G-HSSVJEQC95"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.firebaseDB = { db, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, query, where, deleteDoc, getDocs };

    async function loginAsTeacher() {
        const accountInput = document.getElementById('teacherAccount').value;
        const passwordInput = document.getElementById('teacherPassword').value;
        if (!accountInput || !passwordInput) { alert("è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼å“¦ï¼"); return; }
        try {
            const docRef = doc(db, "admins", accountInput);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists() && docSnap.data().password === passwordInput) {
                showPage('page_teacher_dash');
            } else { alert("å¸³è™Ÿæˆ–å¯†ç¢¼ä¸å°å–”ï¼"); }
        } catch (e) { alert("ç³»çµ±å‡ºéŒ¯äº†ï¼Œè«‹ç¨å¾Œå†è©¦"); }
    }
    window.loginAsTeacher = loginAsTeacher;
</script>

<script>
    let cloudData = { roomID: "", roomList: [], wordBank: [], publishedWords: [] };
    let unsubResults = null;

    async function syncConfigFromCloud() {
        const { db, doc, getDoc, setDoc } = window.firebaseDB;
        const configDoc = await getDoc(doc(db, "configs", "main"));
        if (configDoc.exists()) { cloudData = { ...cloudData, ...configDoc.data() }; }
        else { await setDoc(doc(db, "configs", "main"), { roomList: [], wordBank: ["HELLO"], publishedWords: [], roomID: "" }); }
    }

    async function updateCloudConfig(newData) {
        const { db, doc, updateDoc } = window.firebaseDB;
        await updateDoc(doc(db, "configs", "main"), newData);
    }

    async function saveRoomID() {
        const input = document.getElementById('class_room_id');
        let id = input.value.trim();
        if (!id) return;
        await syncConfigFromCloud();
        if (!cloudData.roomList.includes(id)) cloudData.roomList.push(id);
        cloudData.roomID = id;
        await updateCloudConfig({ roomList: cloudData.roomList, roomID: id });
        input.value = ""; renderTeacherDash();
    }

    async function selectRoom(id) { cloudData.roomID = id; await updateCloudConfig({ roomID: id }); renderTeacherDash(); }

    async function deleteRoom(id, event) {
        event.stopPropagation();
        if(confirm(`çœŸçš„è¦åˆªé™¤æˆ¿é–“ ${id} å—ï¼Ÿ`)) {
            await syncConfigFromCloud();
            cloudData.roomList = cloudData.roomList.filter(r => r !== id);
            if(cloudData.roomID === id) cloudData.roomID = "";
            await updateCloudConfig({ roomList: cloudData.roomList, roomID: cloudData.roomID });
            const { db, collection, query, where, getDocs, deleteDoc, doc } = window.firebaseDB;
            const snapshot = await getDocs(query(collection(db, "results"), where("room", "==", id)));
            snapshot.forEach(async (d) => await deleteDoc(doc(db, "results", d.id)));
            renderTeacherDash();
        }
    }

    async function addNewWord() {
        let w = document.getElementById('new_word').value.toUpperCase().trim();
        if(w && !cloudData.wordBank.includes(w)) {
            cloudData.wordBank.push(w); await updateCloudConfig({ wordBank: cloudData.wordBank });
            renderWordListOnly(); document.getElementById('new_word').value = "";
        }
    }

    async function publishSelectedWords() {
        const cbs = document.querySelectorAll('.word-checkbox:checked');
        cloudData.publishedWords = Array.from(cbs).map(c => c.value);
        if(cloudData.publishedWords.length === 0) return alert("è¦å…ˆå‹¾é¸é¡Œç›®å–”ï¼");
        await updateCloudConfig({ publishedWords: cloudData.publishedWords });
        renderTeacherDash(); alert("ç™¼ä½ˆæˆåŠŸï¼å¿«å«å­¸ç”Ÿé–‹å§‹å§ï¼");
    }

    async function deleteSelectedWords() {
        const cbs = document.querySelectorAll('.word-checkbox:checked');
        const toDel = Array.from(cbs).map(c => c.value);
        if(confirm("ç¢ºå®šåˆªé™¤é€™äº›é¡Œç›®ï¼Ÿ")) {
            cloudData.wordBank = cloudData.wordBank.filter(w => !toDel.includes(w));
            cloudData.publishedWords = cloudData.publishedWords.filter(w => !toDel.includes(w));
            await updateCloudConfig({ wordBank: cloudData.wordBank, publishedWords: cloudData.publishedWords });
            renderTeacherDash();
        }
    }

    function renderWordListOnly() {
        const list = document.getElementById('word_list');
        list.innerHTML = "";
        cloudData.wordBank.forEach(w => {
            list.innerHTML += `<div style="margin-bottom:8px;"><label style="cursor:pointer; display:flex; align-items:center; gap:8px;"><input type="checkbox" class="word-checkbox" value="${w}" style="width:20px;height:20px;"> ${w}</label></div>`;
        });
    }

    function renderTeacherDash() {
        document.getElementById('room_display').innerText = cloudData.roomID || "--";
        document.getElementById('published_display').innerText = cloudData.publishedWords.join(', ') || "å°šæœªå‡ºé¡Œ";
        const chips = document.getElementById('room_chips_container');
        chips.innerHTML = "";
        cloudData.roomList.forEach(id => {
            const active = (id === cloudData.roomID) ? "active" : "";
            chips.innerHTML += `<div class="room-chip ${active}" onclick="selectRoom('${id}')">ğŸ  ${id}<span class="del-x" onclick="deleteRoom('${id}', event)">Ã—</span></div>`;
        });
        if(!document.querySelector('.word-checkbox')) renderWordListOnly();
        
        const { db, collection, query, where, onSnapshot } = window.firebaseDB;
        if(unsubResults) unsubResults();
        const q = query(collection(db, "results"), where("room", "==", cloudData.roomID));
        unsubResults = onSnapshot(q, (snapshot) => {
            const tbody = document.querySelector('#leaderboard tbody');
            tbody.innerHTML = "";
            let data = [];
            snapshot.forEach(doc => data.push(doc.data()));
            data.sort((a,b) => b.avg - a.avg).forEach(r => {
                let detail = Object.entries(r.details).map(([w, s]) => `${w}: ${s}`).join(' | ');
                let thumbHtml = r.bestImg ? `<img src="${r.bestImg}" class="work-thumb" onclick="openArt('${r.bestImg}', '${r.name}')">` : "â˜ï¸";
                tbody.innerHTML += `<tr><td>${thumbHtml}</td><td><b>[${r.class}] ${r.name}</b></td><td style="color:#4caf50; font-size:18px; font-weight:bold;">${r.avg}</td><td style="font-size:11px; color:#888;">${detail}</td><td>${r.finished}/${r.total}</td></tr>`;
            });
        });
    }

    function openArt(src, name) { document.getElementById('big_art').src = src; document.getElementById('art_info').innerText = "å°ç•«å®¶: " + name; document.getElementById('artwork_modal').style.display = "flex"; }
    function closeArt() { document.getElementById('artwork_modal').style.display = "none"; }

    // --- å­¸ç”Ÿç«¯é‚è¼¯ ---
    let studentState = { room:"", class:"", name:"", queue:[], currentIdx: 0, scores:{}, bestScore: 0, bestImg: "" };

    async function handleStudentEntry() {
        await syncConfigFromCloud();
        let room = document.getElementById('s_room_input').value.trim();
        if(!cloudData.roomList.includes(room)) { alert("æˆ¿è™Ÿä¸å°å–”ï¼Œå†å•å•è€å¸«ï¼"); return; }
        if(cloudData.publishedWords.length === 0) { alert("è€å¸«é‚„æ²’å‡ºé¡Œè€¶ï¼"); return; }
        studentState = { room, class: document.getElementById('s_class').value, name: document.getElementById('s_name').value, queue: [...cloudData.publishedWords], currentIdx: 0, scores: {}, bestScore: 0, bestImg: "" };
        showPage('page_writing');
    }

    function updateWritingUI() {
        const w = studentState.queue[studentState.currentIdx];
        document.getElementById('target_word').innerText = w || "çµæŸäº†ï¼";
        document.getElementById('progress_info').innerText = `ç¬¬ ${studentState.currentIdx + 1} / ${studentState.queue.length} å€‹`;
        document.getElementById('btn_submit_score').disabled = false;
        document.getElementById('btn_submit_score').innerText = "âœ… å®Œæˆæäº¤";
    }

    const video = document.getElementById('input_video'), canvas = document.getElementById('overlay_canvas'), ctx = canvas.getContext('2d');
    let allPaths = [], currentStroke = [], lastX = 0, lastY = 0;

    function onResults(res) {
        ctx.save(); ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
        ctx.drawImage(res.image, 0, 0, canvas.width, canvas.height);
        const w = studentState.queue[studentState.currentIdx];
        if(w) {
            let fs = Math.min(250, (canvas.width / w.length) * 1.2);
            ctx.save(); ctx.translate(canvas.width/2, canvas.height/2); ctx.scale(-1, 1); ctx.globalAlpha = 0.45; ctx.fillStyle = 'white';
            ctx.font = `bold ${fs}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(w, 0, 0); ctx.restore();
        }
        if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
            const h = res.multiHandLandmarks[0];
            const d = Math.sqrt(Math.pow(h[4].x-h[8].x,2)+Math.pow(h[4].y-h[8].y,2));
            const rx = h[8].x * canvas.width, ry = h[8].y * canvas.height;
            if (lastX === 0) { lastX = rx; lastY = ry; }
            const sx = lastX + (rx - lastX) * 0.3, sy = lastY + (ry - lastY) * 0.3; lastX = sx; lastY = sy;
            if (d < 0.035) currentStroke.push({ x: sx, y: sy });
            else if (currentStroke.length > 0) { allPaths.push([...currentStroke]); currentStroke = []; }
            ctx.fillStyle = "#ff5252"; ctx.beginPath(); ctx.arc(sx, sy, 10, 0, Math.PI*2); ctx.fill();
        }
        ctx.strokeStyle = '#81c784'; ctx.lineWidth = 18; ctx.lineCap = 'round';
        [...allPaths, currentStroke].forEach(p => {
            if (p.length < 2) return;
            ctx.beginPath(); ctx.moveTo(p[0].x, p[0].y);
            for(let i=1; i<p.length-1; i++) ctx.quadraticCurveTo(p[i].x, p[i].y, (p[i].x+p[i+1].x)/2, (p[i].y+p[i+1].y)/2);
            ctx.stroke();
        });
        ctx.restore();
    }

    async function calculateFinalScore() {
        const btn = document.getElementById('btn_submit_score');
        btn.disabled = true; btn.innerText = "æ‰“åˆ†æ•¸ä¸­...";

        const w = studentState.queue[studentState.currentIdx];
        const off = document.createElement('canvas'); off.width = canvas.width; off.height = canvas.height;
        const octx = off.getContext('2d');
        let fs = Math.min(250, (off.width / w.length) * 1.2);
        octx.save(); octx.translate(off.width/2, off.height/2); octx.scale(-1,1);
        octx.font = `bold ${fs}px Arial`; octx.textAlign="center"; octx.textBaseline="middle"; octx.lineWidth = 25; octx.strokeText(w, 0, 0); octx.fillText(w, 0, 0); octx.restore();
        const tD = octx.getImageData(0,0,off.width,off.height).data;
        octx.clearRect(0,0,off.width,off.height); octx.strokeStyle = '#4caf50'; octx.lineWidth = 15; octx.lineCap = 'round';
        [...allPaths, currentStroke].forEach(p => {
            if (p.length < 2) return;
            octx.beginPath(); octx.moveTo(p[0].x, p[0].y);
            for(let i=1; i<p.length-1; i++) octx.quadraticCurveTo(p[i].x, p[i].y, (p[i].x+p[i+1].x)/2, (p[i].y+p[i+1].y)/2);
            octx.stroke();
        });
        let img = off.toDataURL("image/jpeg", 0.15);
        const sD = octx.getImageData(0,0,off.width,off.height).data;
        let m=0, t=0; for (let i=3; i<tD.length; i+=16) { if(tD[i]>0){ t++; if(sD[i]>0) m++; } }
        let cov = (m/t)*100;
        let sc = cov > 65 ? (90+(cov-65)/3.5) : (cov > 35 ? (70+(cov-35)*0.6) : (40+cov*2));
        sc = Math.min(100, Math.round(sc));
        studentState.scores[w] = sc;
        if (sc >= studentState.bestScore) { studentState.bestScore = sc; studentState.bestImg = img; }

        const { db, setDoc, doc } = window.firebaseDB;
        let fin = Object.keys(studentState.scores).length, tot = studentState.queue.length, av = Math.round(Object.values(studentState.scores).reduce((a,b)=>a+b,0) / fin);
        await setDoc(doc(db, "results", `${studentState.room}_${studentState.class}_${studentState.name}`), {
            room: studentState.room, class: studentState.class, name: studentState.name, details: studentState.scores, finished: fin, total: tot, avg: av, bestImg: studentState.bestImg
        });
        document.getElementById('res_score').innerText = sc;
        document.getElementById('res_stars').innerText = "â­".repeat(sc >= 90 ? 5 : (sc >= 75 ? 4 : 3));
        document.getElementById('result_modal').style.display = "block";
    }

    function toNextStep() {
        document.getElementById('result_modal').style.display = "none"; clearCanvas();
        if(studentState.currentIdx < studentState.queue.length - 1) { 
            studentState.currentIdx++; updateWritingUI(); 
        } else { 
            // å¦‚æœå®Œæˆäº†æ‰€æœ‰å–®å­—ï¼Œé¡¯ç¤ºæœ€å¾Œçš„å¯æ„›ç¸½çµè¦–çª—
            document.getElementById('final_modal').style.display = "block";
        }
    }

    function restartChallenge() {
        document.getElementById('final_modal').style.display = "none";
        studentState.currentIdx = 0;
        studentState.scores = {};
        updateWritingUI();
    }

    function exitChallenge() {
        document.getElementById('final_modal').style.display = "none";
        showPage('page_entry');
    }

    async function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'page_teacher_dash') { await syncConfigFromCloud(); renderTeacherDash(); }
        if(id === 'page_writing') {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight; updateWritingUI();
            const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
            hands.setOptions({ maxNumHands:1, modelComplexity:1, minDetectionConfidence:0.7, minTrackingConfidence:0.7 });
            hands.onResults(onResults);
            new Camera(video, { onFrame: async () => { await hands.send({image: video}); }, width:1280, height:720 }).start();
        }
    }
    function clearCanvas() { allPaths = []; currentStroke = []; lastX = 0; lastY = 0; }
    async function clearScores() { if(confirm("ç¢ºå®šè¦æ¸…ç©ºå¤§å®¶çš„åˆ†æ•¸å—ï¼Ÿ")) { const { db, collection, query, where, getDocs, deleteDoc, doc } = window.firebaseDB; const snapshot = await getDocs(query(collection(db, "results"), where("room", "==", cloudData.roomID))); snapshot.forEach(async (d) => await deleteDoc(doc(db, "results", d.id))); } }
</script>
</body>
</html>
