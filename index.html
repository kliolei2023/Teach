<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‰‹å‹¢æ›¸å¯« - iPadç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .app-container {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow: hidden;
        }

        .header {
            text-align: center;
            padding: 15px 0;
            color: white;
            flex-shrink: 0;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .status-bar {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            flex-shrink: 0;
        }

        .status-item {
            text-align: center;
            min-width: 80px;
        }

        .status-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 3px;
        }

        .status-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #4fc3f7;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 10px;
            border-radius: 10px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow: hidden;
        }

        .target-section {
            flex: 0 0 45%;
            min-height: 0;
        }

        .target-container {
            position: relative;
            height: 100%;
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        #targetWord {
            position: absolute;
            font-size: 30vh;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #drawingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            touch-action: none;
        }

        .camera-section {
            flex: 0 0 45%;
            min-height: 0;
            position: relative;
        }

        .camera-container {
            position: relative;
            height: 100%;
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: #000;
        }

        #cameraVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            background: #000;
        }

        .gesture-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            z-index: 3;
        }

        .gesture-active {
            background: rgba(76, 175, 80, 0.9);
        }

        .controls {
            flex-shrink: 0;
            padding: 10px 0;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 12px;
            padding: 15px 5px;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .control-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-icon {
            font-size: 1.5rem;
        }

        #startBtn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
        }

        #clearBtn {
            background: linear-gradient(135deg, #FF9800, #EF6C00);
        }

        #nextBtn {
            background: linear-gradient(135deg, #2196F3, #0D47A1);
        }

        .instructions {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .instructions strong {
            color: #4fc3f7;
        }

        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ©«å‘æ¨¡å¼èª¿æ•´ */
        @media (orientation: landscape) {
            .main-content {
                flex-direction: row;
            }
            .target-section, .camera-section {
                flex: 1;
            }
            #targetWord {
                font-size: 25vh;
            }
        }
    </style>
</head>
<body>
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <h3>æº–å‚™ä¸­...</h3>
        <p id="loaderText">è«‹ç¨å€™</p>
    </div>

    <div class="app-container">
        <div class="header">
            <h1>âœï¸ æ‰‹å‹¢æ›¸å¯«æ¸¬è©¦</h1>
            <p class="subtitle">ç°¡å–®çš„æ‰‹å‹¢åµæ¸¬ç‰ˆæœ¬</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">ç•¶å‰å­—æ¯</div>
                <div class="status-value" id="currentLetter">A</div>
            </div>
            <div class="status-item">
                <div class="status-label">æ›¸å¯«ç‹€æ…‹</div>
                <div class="status-value" id="drawingStatus">ç­‰å¾…</div>
            </div>
            <div class="status-item">
                <div class="status-label">æ¨¡å¼</div>
                <div class="status-value" id="modeStatus">è§¸æ§</div>
            </div>
        </div>

        <div class="main-content">
            <div class="target-section">
                <div class="target-container">
                    <div id="targetWord">A</div>
                    <canvas id="drawingCanvas"></canvas>
                </div>
            </div>

            <div class="camera-section">
                <div class="camera-container">
                    <video id="cameraVideo" autoplay playsinline></video>
                    <div class="gesture-indicator" id="gestureIndicator">
                        ğŸ‘† æº–å‚™ä¸­
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="controls-grid">
                <button class="control-btn" id="startBtn">
                    <span class="btn-icon">ğŸ“·</span>
                    <span>é–‹å•Ÿé¡é ­</span>
                </button>
                <button class="control-btn" id="clearBtn">
                    <span class="btn-icon">ğŸ§¹</span>
                    <span>æ¸…é™¤ç­†è·¡</span>
                </button>
                <button class="control-btn" id="nextBtn">
                    <span class="btn-icon">â­</span>
                    <span>è©•åˆ†</span>
                </button>
            </div>
            
            <div class="instructions">
                <strong>ä½¿ç”¨èªªæ˜ï¼š</strong> 
                1. é»ã€Œé–‹å•Ÿé¡é ­ã€ 2. å…è¨±ç›¸æ©Ÿæ¬Šé™ 3. ç”¨æ‰‹åœ¨é¡é ­å‰ç§»å‹• 4. ç”¨æ‰‹æŒ‡è§¸æ§ç•«é¢æ›¸å¯«
            </div>
        </div>
    </div>

    <script>
        // ç²å–DOMå…ƒç´ 
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const targetWord = document.getElementById('targetWord');
        const drawingCanvas = document.getElementById('drawingCanvas');
        const drawingCtx = drawingCanvas.getContext('2d');
        const cameraVideo = document.getElementById('cameraVideo');
        const startBtn = document.getElementById('startBtn');
        const clearBtn = document.getElementById('clearBtn');
        const nextBtn = document.getElementById('nextBtn');
        const drawingStatus = document.getElementById('drawingStatus');
        const modeStatus = document.getElementById('modeStatus');
        const gestureIndicator = document.getElementById('gestureIndicator');
        
        // ç‹€æ…‹è®Šæ•¸
        let isDrawing = false;
        let isCameraOn = false;
        let currentScore = 0;
        const words = ['A', 'B', 'C', 'D', 'E'];
        let currentWordIndex = 0;
        
        // ç¹ªè£½è¨­å®š
        drawingCtx.lineWidth = 8;
        drawingCtx.lineCap = 'round';
        drawingCtx.lineJoin = 'round';
        drawingCtx.strokeStyle = '#FF5722';
        
        // åˆå§‹åŒ–
        function init() {
            console.log('ç³»çµ±åˆå§‹åŒ–...');
            
            // èª¿æ•´ç•«å¸ƒå¤§å°
            resizeCanvas();
            
            // è¨­å®šäº‹ä»¶ç›£è½
            setupEventListeners();
            
            // æ›´æ–°åˆå§‹ç‹€æ…‹
            updateStatus('ç­‰å¾…é–‹å§‹');
            modeStatus.textContent = 'è§¸æ§';
            
            // éš±è—åŠ è¼‰ç•«é¢
            setTimeout(() => {
                loader.style.display = 'none';
            }, 1000);
            
            console.log('åˆå§‹åŒ–å®Œæˆ');
        }
        
        // èª¿æ•´ç•«å¸ƒå¤§å°
        function resizeCanvas() {
            const container = drawingCanvas.parentElement;
            drawingCanvas.width = container.clientWidth;
            drawingCanvas.height = container.clientHeight;
        }
        
        // è¨­å®šäº‹ä»¶ç›£è½
        function setupEventListeners() {
            // è¦–çª—å¤§å°è®ŠåŒ–
            window.addEventListener('resize', resizeCanvas);
            window.addEventListener('orientationchange', () => {
                setTimeout(resizeCanvas, 300);
            });
            
            // æŒ‰éˆ•äº‹ä»¶
            startBtn.addEventListener('click', toggleCamera);
            clearBtn.addEventListener('click', clearDrawing);
            nextBtn.addEventListener('click', evaluateAndNext);
            
            // è§¸æ§äº‹ä»¶ - ç”¨æ–¼æ›¸å¯«
            drawingCanvas.addEventListener('touchstart', startTouchDrawing);
            drawingCanvas.addEventListener('touchmove', continueTouchDrawing);
            drawingCanvas.addEventListener('touchend', endTouchDrawing);
            
            // æ»‘é¼ äº‹ä»¶ï¼ˆåœ¨é›»è…¦ä¸Šæ¸¬è©¦ç”¨ï¼‰
            drawingCanvas.addEventListener('mousedown', startMouseDrawing);
            drawingCanvas.addEventListener('mousemove', continueMouseDrawing);
            drawingCanvas.addEventListener('mouseup', endMouseDrawing);
            drawingCanvas.addEventListener('mouseleave', endMouseDrawing);
            
            // ç›£è½ç›¸æ©Ÿæµ
            cameraVideo.addEventListener('play', () => {
                console.log('é¡é ­é–‹å§‹é‹ä½œ');
                isCameraOn = true;
                gestureIndicator.textContent = 'ğŸ“¹ é¡é ­é–‹å•Ÿ';
                updateStatus('é¡é ­é–‹å•Ÿä¸­');
                startSimpleHandDetection();
            });
        }
        
        // åˆ‡æ›é¡é ­
        async function toggleCamera() {
            if (isCameraOn) {
                // é—œé–‰é¡é ­
                const stream = cameraVideo.srcObject;
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                cameraVideo.srcObject = null;
                isCameraOn = false;
                startBtn.innerHTML = '<span class="btn-icon">ğŸ“·</span><span>é–‹å•Ÿé¡é ­</span>';
                gestureIndicator.textContent = 'ğŸ“· é¡é ­é—œé–‰';
                updateStatus('é¡é ­å·²é—œé–‰');
            } else {
                // é–‹å•Ÿé¡é ­
                try {
                    loader.style.display = 'flex';
                    loaderText.textContent = 'æ­£åœ¨è«‹æ±‚é¡é ­æ¬Šé™...';
                    
                    const constraints = {
                        video: {
                            facingMode: 'user',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    cameraVideo.srcObject = stream;
                    startBtn.innerHTML = '<span class="btn-icon">â¹ï¸</span><span>é—œé–‰é¡é ­</span>';
                    
                    loaderText.textContent = 'é¡é ­å·²é–‹å•Ÿï¼';
                    setTimeout(() => {
                        loader.style.display = 'none';
                    }, 1000);
                    
                } catch (error) {
                    console.error('ç„¡æ³•é–‹å•Ÿé¡é ­:', error);
                    loader.style.display = 'none';
                    alert('ç„¡æ³•é–‹å•Ÿé¡é ­ï¼š' + error.message + '\n\nè«‹ç¢ºèªï¼š\n1. å·²å…è¨±ç›¸æ©Ÿæ¬Šé™\n2. æ²’æœ‰å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ç›¸æ©Ÿ\n3. åœ¨ Safari ä¸­é–‹å•Ÿæ­¤é é¢');
                    
                    if (error.name === 'NotAllowedError') {
                        // iPad Safari æ¬Šé™æç¤º
                        alert('è«‹åœ¨ Safari ä¸­ï¼š\n1. é»æ“Šç¶²å€æ¬„çš„ã€ŒaAã€åœ–æ¨™\n2. é¸æ“‡ã€Œç¶²ç«™è¨­å®šã€\n3. å°‡ã€Œç›¸æ©Ÿã€è¨­ç‚ºã€Œå…è¨±ã€\n4. é‡æ–°æ•´ç†é é¢');
                    }
                }
            }
        }
        
        // ç°¡åŒ–çš„æ‰‹å‹¢åµæ¸¬ï¼ˆåŸºæ–¼è‰²å½©å’Œç§»å‹•ï¼‰
        function startSimpleHandDetection() {
            if (!isCameraOn) return;
            
            console.log('å•Ÿå‹•ç°¡å–®æ‰‹å‹¢åµæ¸¬');
            
            // å»ºç«‹ä¸€å€‹éš±è—çš„ canvas ä¾†åˆ†æå½±ç‰‡å¹€
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // è¨­å®šèˆ‡å½±ç‰‡ç›¸åŒçš„å°ºå¯¸
            tempCanvas.width = 160;  // é™ä½è§£æåº¦ä»¥æé«˜æ€§èƒ½
            tempCanvas.height = 120;
            
            let lastFrame = null;
            let motionLevel = 0;
            
            function detectMotion() {
                if (!isCameraOn || cameraVideo.paused || cameraVideo.ended) {
                    return;
                }
                
                try {
                    // ç¹ªè£½ç•¶å‰å¹€åˆ°è‡¨æ™‚ç•«å¸ƒ
                    tempCtx.drawImage(cameraVideo, 0, 0, tempCanvas.width, tempCanvas.height);
                    const currentFrame = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                    
                    if (lastFrame) {
                        // ç°¡å–®çš„å¹€å·®æ³•åµæ¸¬ç§»å‹•
                        let diff = 0;
                        const data1 = lastFrame.data;
                        const data2 = currentFrame.data;
                        
                        for (let i = 0; i < data1.length; i += 4) {
                            const r1 = data1[i];
                            const g1 = data1[i + 1];
                            const b1 = data1[i + 2];
                            const r2 = data2[i];
                            const g2 = data2[i + 1];
                            const b2 = data2[i + 2];
                            
                            const pixelDiff = Math.abs(r1 - r2) + Math.abs(g1 - g2) + Math.abs(b1 - b2);
                            if (pixelDiff > 30) {
                                diff++;
                            }
                        }
                        
                        // è¨ˆç®—ç§»å‹•ç¨‹åº¦ï¼ˆ0-100ï¼‰
                        motionLevel = Math.min(100, Math.round((diff / (tempCanvas.width * tempCanvas.height)) * 1000));
                        
                        // æ›´æ–°æŒ‡ç¤ºå™¨
                        if (motionLevel > 20) {
                            gestureIndicator.textContent = `ğŸ‘‹ åµæ¸¬åˆ°ç§»å‹• (${motionLevel}%)`;
                            gestureIndicator.classList.add('gesture-active');
                        } else {
                            gestureIndicator.textContent = 'ğŸ‘† è«‹ç§»å‹•æ‰‹éƒ¨';
                            gestureIndicator.classList.remove('gesture-active');
                        }
                        
                        // æ›´æ–°æ¨¡å¼ç‹€æ…‹
                        if (motionLevel > 50) {
                            modeStatus.textContent = 'æ‰‹å‹¢æ¨¡å¼';
                            updateStatus('æ‰‹å‹¢åµæ¸¬ä¸­');
                        } else {
                            modeStatus.textContent = 'è§¸æ§æ¨¡å¼';
                        }
                    }
                    
                    lastFrame = currentFrame;
                    
                    // ç¹¼çºŒåµæ¸¬
                    requestAnimationFrame(detectMotion);
                    
                } catch (error) {
                    console.error('åµæ¸¬éŒ¯èª¤:', error);
                }
            }
            
            // é–‹å§‹åµæ¸¬
            detectMotion();
        }
        
        // è§¸æ§ç¹ªè£½åŠŸèƒ½
        function startTouchDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            
            const touch = e.touches[0];
            const rect = drawingCanvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            drawingCtx.beginPath();
            drawingCtx.moveTo(x, y);
            updateStatus('æ›¸å¯«ä¸­...');
        }
        
        function continueTouchDrawing(e) {
            e.preventDefault();
            if (!isDrawing) return;
            
            const touch = e.touches[0];
            const rect = drawingCanvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            drawingCtx.lineTo(x, y);
            drawingCtx.stroke();
        }
        
        function endTouchDrawing(e) {
            e.preventDefault();
            isDrawing = false;
            drawingCtx.closePath();
            updateStatus('å®Œæˆæ›¸å¯«');
        }
        
        // æ»‘é¼ ç¹ªè£½åŠŸèƒ½ï¼ˆé›»è…¦æ¸¬è©¦ç”¨ï¼‰
        function startMouseDrawing(e) {
            isDrawing = true;
            
            const rect = drawingCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            drawingCtx.beginPath();
            drawingCtx.moveTo(x, y);
            updateStatus('æ›¸å¯«ä¸­...');
        }
        
        function continueMouseDrawing(e) {
            if (!isDrawing) return;
            
            const rect = drawingCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            drawingCtx.lineTo(x, y);
            drawingCtx.stroke();
        }
        
        function endMouseDrawing() {
            isDrawing = false;
            drawingCtx.closePath();
            updateStatus('å®Œæˆæ›¸å¯«');
        }
        
        // æ¸…é™¤ç•«å¸ƒ
        function clearDrawing() {
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            updateStatus('ç•«å¸ƒå·²æ¸…é™¤');
            currentScore = 0;
        }
        
        // è©•åˆ†èˆ‡åˆ‡æ›
        function evaluateAndNext() {
            // ç°¡å–®è©•åˆ†ï¼ˆæª¢æŸ¥ç¹ªè£½é¢ç©ï¼‰
            const imageData = drawingCtx.getImageData(0, 0, drawingCanvas.width, drawingCanvas.height);
            const data = imageData.data;
            
            let drawnPixels = 0;
            for (let i = 0; i < data.length; i += 4) {
                if (data[i + 3] > 10) { // æœ‰ç¹ªè£½çš„åƒç´ 
                    drawnPixels++;
                }
            }
            
            const totalPixels = drawingCanvas.width * drawingCanvas.height;
            const coverage = (drawnPixels / totalPixels) * 100;
            
            // è¨ˆç®—åˆ†æ•¸ï¼ˆ0-100ï¼‰
            currentScore = Math.min(100, Math.round(coverage * 2));
            
            // é¡¯ç¤ºåˆ†æ•¸
            alert(`è©•åˆ†çµæœï¼š${currentScore}åˆ†\n\nç¹ªè£½è¦†è“‹ç‡ï¼š${coverage.toFixed(1)}%`);
            
            // åˆ‡æ›åˆ°ä¸‹ä¸€å€‹å­—æ¯
            currentWordIndex = (currentWordIndex + 1) % words.length;
            targetWord.textContent = words[currentWordIndex];
            document.getElementById('currentLetter').textContent = words[currentWordIndex];
            
            // æ¸…é™¤ç•«å¸ƒ
            setTimeout(clearDrawing, 500);
        }
        
        // æ›´æ–°ç‹€æ…‹
        function updateStatus(status) {
            drawingStatus.textContent = status;
        }
        
        // åˆå§‹åŒ–ç³»çµ±
        window.addEventListener('load', init);
        
        // é˜²æ­¢æ»¾å‹•
        document.addEventListener('touchmove', function(e) {
            if (e.target === drawingCanvas) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
